<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
  <title>ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ  v2</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
  <!-- 404å›é¿ç”¨ã®ãƒ‡ãƒ¼ã‚¿URLãƒ•ã‚¡ãƒ“ã‚³ãƒ³ -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3EğŸ—ºï¸%3C/text%3E%3C/svg%3E">
  <meta name="theme-color" content="#ffffff">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; overscroll-behavior: none; touch-action: manipulation; }

    :root{
      /* ãã™ã¿æ°´è‰²ï¼ˆå£è‰²ï¼‰*/
      --muted-sky: #a7c7d9;
      --muted-sky-dark: #8fb4ca;
    }

    /* ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«å…±é€š */
    .grid-cell { width: 100%; height: 100%; aspect-ratio: 1/1; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; border: 1px solid #d1d5db; background:#f9fafb; position: relative; }
    .setting-grid-cell { width: 100%; aspect-ratio: 1/1; display: flex; justify-content:center; align-items:center; font-size:1.25rem; border:1px solid #e5e7eb; background:#f9fafb; cursor:pointer; }

    #player { font-size: 1.25rem; z-index: 10; transition: none; }
    /* â‘§ ã‚¢ã‚¤ã‚³ãƒ³å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
    .player-icon-inner { display: inline-block; transition: transform 0.3s ease-in-out; }

    /* ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
    .mode-btn { padding: .5rem 0.5rem; border: 1px solid #d1d5db; background:#f9fafb; color:#6b7280; font-size: 0.9rem; }
    .mode-btn.active{ background:#3b82f6; color:#fff; border-color:#3b82f6; }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes ping-effect{0%{transform:scale(1);opacity:1}75%,100%{transform:scale(2);opacity:0}}
    @keyframes tada-effect{0%{transform:scale(1)}10%,20%{transform:scale(.9) rotate(-3deg)}30%,50%,70%,90%{transform:scale(1.1) rotate(3deg)}40%,60%,80%{transform:scale(1.1) rotate(-3deg)}100%{transform:scale(1)}}
    .effect-ping{position:absolute;inset:0;border-radius:50%;background:rgba(34,197,94,.5);animation:ping-effect 1s cubic-bezier(0,0,.2,1)}
    .effect-tada{animation:tada-effect 1s ease-in-out}

    /* è¨­å®šãƒ“ãƒ¥ãƒ¼ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
    #settings-view { scrollbar-width: none; }
    #settings-view::-webkit-scrollbar { width:0; height:0; }

    /* ç›¸å¯¾æ–¹ä½ã‚³ãƒãƒ³ãƒ‰ã®å¼·èª¿è¡¨ç¤º */
    .cmd-relative { border: 2px solid #22d3ee; background-color: #ecfeff; color: #0e7490; font-weight: bold; }

    /* â‘£, â‘¥ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å¼·èª¿ */
    .seq-highlight { background-color: #fef08a; transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .seq-error { background-color: #ef4444; color: white; transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

    /* æ±è¥¿å—åŒ—ãƒ©ãƒ™ãƒ«ï¼ˆæ±è¥¿å—åŒ—ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã ã‘è¡¨ç¤ºï¼‰ */
    .cardinal-label { position:absolute; display:none; font-weight:600; color:#334155; }
    .mode-cardinal .cardinal-label { display:block; }
    .cardinal-n { top: -1.5rem; left: 50%; transform: translateX(-50%); }
    .cardinal-s { bottom: -1.5rem; left: 50%; transform: translateX(-50%); }
    .cardinal-e { right: -1.5rem; top: 50%; transform: translateY(-50%); }
    .cardinal-w { left: -1.5rem; top: 50%; transform: translateY(-50%); }

    /* å£ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆãã™ã¿æ°´è‰²ï¼‰ */
    .wall-cell { background-color: var(--muted-sky); }
    .setting-wall-cell { background-color: var(--muted-sky-dark); }
    /* â‘¡ ä¸€æ–¹å‘å£ */
    .setting-oneway-cell { background-color: #e0f2fe; color: #0c4a6e; }

  </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen w-screen overflow-hidden">

  <!-- è¨­å®šãƒ“ãƒ¥ãƒ¼ -->
  <div id="settings-view" class="p-4 md:p-8 max-w-4xl mx-auto h-full overflow-y-auto">
    <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»ãƒ‘ã‚ºãƒ«</h1>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- å·¦ï¼šå…¥åŠ› -->
      <div class="space-y-6 bg-white p-6 rounded-lg shadow-md">
        <fieldset class="border p-4 rounded-lg">
          <legend class="text-lg font-medium px-2">ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚º</legend>
          <div class="flex gap-4">
            <div>
              <label class="block text-md font-medium mb-2">è¡Œ</label>
              <input id="grid-rows" type="number" min="3" max="10" value="5" class="w-24 p-3 border rounded-lg text-lg" />
            </div>
            <div>
              <label class="block text-md font-medium mb-2">åˆ—</label>
              <input id="grid-cols" type="number" min="3" max="10" value="6" class="w-24 p-3 border rounded-lg text-lg" />
            </div>
          </div>
        </fieldset>
        
        <!-- â‘§ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³é¸æŠ -->
        <fieldset class="border p-4 rounded-lg">
          <legend class="text-lg font-medium px-2">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³</legend>
          <div id="icon-selector" class="flex gap-4 items-center">
            <label class="cursor-pointer"><input type="radio" name="player-icon" value="arrow" checked> <span class="text-2xl ml-1 align-middle">â–²</span></label>
            <label class="cursor-pointer"><input type="radio" name="player-icon" value="car"> <span class="text-2xl ml-1 align-middle">ğŸš—</span></label>
            <label class="cursor-pointer"><input type="radio" name="player-icon" value="chick"> <span class="text-2xl ml-1 align-middle">ğŸ¤</span></label>
          </div>
        </fieldset>

        <fieldset class="border p-4 rounded-lg">
          <legend class="text-lg font-medium px-2">ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ</legend>
          <!-- â‘¡ ä¸€æ–¹å‘å£ / â‘¢ é †åºä»˜ãWP ã‚’è¿½åŠ  -->
          <div id="item-selector" class="grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="start" checked><span class="text-lg text-green-600">â–² ã‚¹ã‚¿ãƒ¼ãƒˆ</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="goal"><span class="text-lg">ğŸ  ã‚´ãƒ¼ãƒ«</span></label>
            
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="wall"><span class="text-lg"><span class="inline-block w-5 h-5 rounded-sm align-middle" style="background: var(--muted-sky);"></span> å£</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="impassable"><span class="text-lg">ğŸ‘» é€šè¡Œä¸å¯</span></label>

            <!-- â‘¢ é †åºä»˜ãWP -->
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="waypoint"><span class="text-lg">1ï¸âƒ£ é€šéåœ°ç‚¹</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="erase"><span class="text-lg">ğŸ—‘ï¸ æ¶ˆã—ã‚´ãƒ </span></label>
            
            <!-- â‘¡ ä¸€æ–¹å‘å£ -->
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="oneWayUp"><span class="text-lg">â¬†ï¸ å£(ä¸Šã¸)</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="oneWayRight"><span class="text-lg">â¡ï¸ å£(å³ã¸)</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="oneWayDown"><span class="text-lg">â¬‡ï¸ å£(ä¸‹ã¸)</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="item-type" value="oneWayLeft"><span class="text-lg">â¬…ï¸ å£(å·¦ã¸)</span></label>
          </div>
          <p class="text-sm text-gray-600 mt-2">é€šéåœ°ç‚¹ã¯ 1, 2, 3... ã®é †ã«é…ç½®ã•ã‚Œã¾ã™ (æœ€å¤§6å€‹)ã€‚</p>
        </fieldset>
        
        <div class="space-y-3 pt-2">
          <button id="random-all-btn" class="w-full p-3 bg-green-500 text-white rounded-lg shadow">ğŸ² å…¨è¨­å®šãƒ©ãƒ³ãƒ€ãƒ </button>
          <button id="random-items-btn" class="w-full p-3 bg-green-500 text-white rounded-lg shadow">ğŸ”„ ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿ãƒ©ãƒ³ãƒ€ãƒ </button>
          <button id="start-game-btn" class="w-full p-3 bg-blue-600 text-white rounded-lg shadow">ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>
        <p id="settings-error" class="text-red-500 text-center h-6"></p>
      </div>
      <!-- å³ï¼šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <div class="bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4 text-center">é…ç½®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <div id="setting-grid-container" class="grid bg-white border border-gray-300 rounded-lg overflow-hidden"></div>
      </div>
    </div>
  </div>

  <!-- ã‚²ãƒ¼ãƒ ãƒ“ãƒ¥ãƒ¼ -->
  <div id="game-view" class="hidden h-screen w-screen flex flex-col p-4">
    <div class="flex justify-between items-center mb-2 w-full max-w-7xl mx-auto flex-shrink-0">
      <!-- â‘  ã‚¿ãƒ¼ãƒ³æ•° -->
      <span id="turn-info" class="text-lg font-medium text-blue-700"></span>
      <!-- â‘¥ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
      <div id="message-area" class="text-xl font-semibold text-green-600 h-8 text-right"></div>
    </div>

    <div class="flex-grow flex flex-col md:flex-row-reverse gap-4 w-full max-w-7xl mx-auto overflow-hidden">
      <!-- å³ï¼šã‚°ãƒªãƒƒãƒ‰ï¼ˆå¤§ï¼‰ -->
      <div class="flex-grow flex justify-center items-center md:w-3/5 h-full relative">
        <!-- æ±è¥¿å—åŒ—ãƒ©ãƒ™ãƒ«ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ -->
        <div id="grid-wrapper" class="relative">
          <span class="cardinal-label cardinal-n">åŒ—</span>
          <span class="cardinal-label cardinal-s">å—</span>
          <span class="cardinal-label cardinal-e">æ±</span>
          <span class="cardinal-label cardinal-w">è¥¿</span>
          <div id="grid-container" class="grid bg-white shadow-lg rounded-lg border border-gray-300"></div>
        </div>
      </div>
      <!-- å·¦ï¼šæ“ä½œï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ -->
      <div class="flex flex-col md:w-2/5 space-y-3 h-full">
        <!-- â‘£, â‘¥ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹è¡¨ç¤º -->
        <div class="bg-white p-3 rounded-lg shadow-md border flex-grow min-h-[320px] overflow-y-auto">
          <div id="sequence-display" class="flex flex-wrap gap-2 text-2xl items-start content-start"></div>
        </div>
        <!-- ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆ3ã¤ï¼‰ -->
        <div class="flex rounded-md shadow-sm">
          <button id="mode-absolute-btn" class="mode-btn active w-1/3 rounded-l-md">çµ¶å¯¾æ–¹ä½</button>
          <button id="mode-cardinal-btn" class="mode-btn w-1/3 border-l-0 border-r-0">æ±è¥¿å—åŒ—</button>
          <button id="mode-relative-btn" class="mode-btn w-1/3 rounded-r-md">ç›¸å¯¾æ–¹ä½</button>
        </div>
        <div id="direction-pad" class="p-2 bg-white rounded-lg shadow-md h-[120px] flex justify-center items-center"></div>
        <div class="grid grid-cols-4 gap-2">
          <button id="undo-btn" class="p-2 bg-blue-500 text-white rounded-lg shadow text-sm">ã‚‚ã©ã™</button>
          <button id="reset-btn" class="p-2 bg-blue-500 text-white rounded-lg shadow text-sm">ã‚¯ãƒªã‚¢</button>
          <button id="step-btn" class="p-2 bg-indigo-500 text-white rounded-lg shadow text-sm">ä¸€æ‰‹é€²ã‚€</button>
          <button id="run-btn" class="p-2 bg-green-600 text-white rounded-lg shadow text-sm">å®Ÿè¡Œ</button>
        </div>
        <button id="back-to-settings-btn" class="text-gray-500 hover:underline text-center text-lg p-1">è¨­å®šã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
  const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const shuffle = (arr) => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const delay=ms=>new Promise(res=>setTimeout(res,ms));

  document.addEventListener('DOMContentLoaded', () => {
    // DOMå–å¾—
    const settingsView = document.getElementById('settings-view');
    const gameView = document.getElementById('game-view');
    const gridRowsInput = document.getElementById('grid-rows');
    const gridColsInput = document.getElementById('grid-cols');
    const itemSelector = document.getElementById('item-selector');
    const settingGridContainer = document.getElementById('setting-grid-container');
    const randomAllBtn = document.getElementById('random-all-btn');
    const randomItemsBtn = document.getElementById('random-items-btn');
    const startGameBtn = document.getElementById('start-game-btn');
    const settingsError = document.getElementById('settings-error');
    const iconSelector = document.getElementById('icon-selector'); // â‘§

    const backToSettingsBtn = document.getElementById('back-to-settings-btn');
    const gridContainer = document.getElementById('grid-container');
    const gridWrapper = document.getElementById('grid-wrapper');
    const sequenceDisplay = document.getElementById('sequence-display');
    const directionPad = document.getElementById('direction-pad');

    const modeAbsoluteBtn = document.getElementById('mode-absolute-btn');
    const modeCardinalBtn = document.getElementById('mode-cardinal-btn');
    const modeRelativeBtn = document.getElementById('mode-relative-btn');

    const undoBtn = document.getElementById('undo-btn');
    const resetBtn = document.getElementById('reset-btn');
    const stepBtn = document.getElementById('step-btn');
    const runBtn = document.getElementById('run-btn');
    const messageArea = document.getElementById('message-area'); // â‘¥
    const turnInfo = document.getElementById('turn-info'); // â‘ 

    // ---- éŸ³ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã®ã¿åˆæœŸåŒ–ï¼šiPadå¯¾å¿œï¼‰----
    let synth; let drum; let noise; let mono;
    async function initAudio(){
      try{
        if(!synth){
          if (Tone.context.state !== 'running') await Tone.start();
          synth=new Tone.Synth({ oscillator:{type:'triangle'}, envelope:{attack:0.01,decay:0.2,sustain:0,release:0.8} }).toDestination();
          mono=new Tone.MonoSynth({ oscillator:{type:'square'}, envelope:{attack:0.01,decay:0.3,sustain:0,release:1.2} }).toDestination();
          drum=new Tone.MembraneSynth({ pitchDecay:0.03, octaves:6, oscillator:{type:'sine'}, envelope:{attack:0.001,decay:0.4,sustain:0,release:0.1} }).toDestination();
          noise=new Tone.NoiseSynth({ volume:-10, envelope:{attack:0.001, decay:0.15, sustain:0} }).toDestination();
        }
      }catch(e){ console.warn('Audio init deferred:', e?.message); }
    }
    ['pointerdown','keydown','touchstart'].forEach(ev=>{
      window.addEventListener(ev, ()=>initAudio(), { once:true, passive:true });
    });

    function playTone(freqOrNote, dur){ if(synth) synth.triggerAttackRelease(freqOrNote,dur); }

    // âœ… ã‚´ãƒ¼ãƒ«æˆåŠŸéŸ³ï¼ˆæ˜ã‚‹ã‚ï¼‰
    function playSuccess(){
      if(!synth) return;
      const now = Tone.now();
      const notes = ['C5','E5','G5','C6'];
      notes.forEach((n,i)=>synth.triggerAttackRelease(n, 0.12, now + i*0.12));
    }

    // âœ… å¤±æ•—éŸ³ï¼šã€Œã¡ã‚ƒã‚‰ã‚Šã‚ã‚Šãƒ¼ã‚“â†“ã€ä½ã‚ãƒ»é•·ã‚ï¼ˆä¸‹é™ï¼‰
    function playFailLong(){
      if(!mono) return;
      const t = Tone.now();
      const seq = [ ['E3',0.25], ['D3',0.25], ['C3',0.35], ['A2',0.6] ]; // ä¸‹é™ã—ã¦æœ€å¾Œé•·ã‚
      let acc = 0;
      seq.forEach(([n,d])=>{ mono.triggerAttackRelease(n, d, t+acc); acc += d*0.9; });
    }

    // âœ… ğŸ‘»ãƒ’ãƒƒãƒˆéŸ³ï¼šã€Œã©ã£ãƒ»ã©ã£ãƒ»ã©ãƒ¼ã¨ãƒ¼ã€3é€£ãƒ‰ãƒ©ãƒ ï¼‹ãƒã‚¤ã‚º å³çµ‚äº†
    function playGhostTriple(){
      if(!drum||!noise) return;
      const t = Tone.now();
      drum.triggerAttackRelease('C2','8n', t + 0.00); // ã©ã£
      drum.triggerAttackRelease('C2','8n', t + 0.28); // ã©ã£
      drum.triggerAttackRelease('A1','4n', t + 0.56); // ã©ãƒ¼ãƒ¼
      noise.triggerAttackRelease('16n', t + 0.60);   // ã¨ãƒ¼ï¼ˆãƒã‚¤ã‚ºæ·»ãˆï¼‰
    }

    // çŠ¶æ…‹
    // â‘¢ ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ (1ï¸âƒ£ã€œ6ï¸âƒ£)
    const waypointIcons = ['1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£'];
    const onewayIcons = { oneWayUp: 'â¬†ï¸', oneWayDown: 'â¬‡ï¸', oneWayLeft: 'â¬…ï¸', oneWayRight: 'â¡ï¸' };

    let gameConfig = { 
        gridRows:5, 
        gridCols:6, 
        start:null, 
        goal:null, 
        waypoints:[], // â‘¢ {row, col, order}
        walls:[], 
        impassables: [], 
        oneWayWalls: [], // â‘¡ {row, col, direction}
        waypointsCount:0, 
        playerIcon: 'arrow', // â‘§
        targetMoves: 0 // â‘ 
    };
    let gameState = { 
        player:{row:0,col:0,dir:'up'}, 
        sequence:[], 
        originalSequence: [], // â‘£ å®Ÿè¡Œç”¨ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
        collectedWaypoints:new Set(), 
        isRunning:false, 
        moveMode:'absolute', 
        exploded:false,
        nextWaypointOrder: 1, // â‘¢
        currentStepIndex: 0, // â‘£
        totalMoves: 0 // â‘ 
    };

    const playerElement = document.createElement('span');
    playerElement.id='player';
    // â‘§ ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­èº«ã¯ showGameView ã§è¨­å®š

    // è¨­å®šã‚°ãƒªãƒƒãƒ‰
    gridRowsInput.addEventListener('input', updateSettingGrid);
    gridColsInput.addEventListener('input', updateSettingGrid);

    function updateSettingGrid(){
      const rows = clamp(parseInt(gridRowsInput.value)||5,3,10);
      const cols = clamp(parseInt(gridColsInput.value)||6,3,10);
      gridRowsInput.value = rows; gridColsInput.value = cols;
      gameConfig.gridRows = rows; gameConfig.gridCols = cols;
      settingGridContainer.innerHTML='';
      settingGridContainer.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
      
      // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºå¤‰æ›´ã§ç¯„å›²å¤–ã«ãªã£ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤
      if (gameConfig.start && (gameConfig.start.row>=rows||gameConfig.start.col>=cols)) gameConfig.start=null;
      if (gameConfig.goal && (gameConfig.goal.row>=rows||gameConfig.goal.col>=cols)) gameConfig.goal=null;
      gameConfig.waypoints = gameConfig.waypoints.filter(w=>w.row<rows&&w.col<cols);
      gameConfig.walls = gameConfig.walls.filter(w=>w.row<rows&&w.col<cols);
      gameConfig.impassables = gameConfig.impassables.filter(w=>w.row<rows&&w.col<cols);
      gameConfig.oneWayWalls = gameConfig.oneWayWalls.filter(w=>w.row<rows&&w.col<cols); // â‘¡
      
      // â‘¢ ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆã®é †åºã‚’å†å‰²ã‚Šå½“ã¦
      gameConfig.waypoints.sort((a,b) => a.order - b.order);
      gameConfig.waypoints.forEach((wp, i) => wp.order = i + 1);

      for(let r=0;r<rows;r++) for(let c=0;c<cols;c++){
        const d=document.createElement('div');
        d.className='setting-grid-cell';
        d.dataset.row=r; d.dataset.col=c;
        d.addEventListener('click', onSettingCellClick);
        settingGridContainer.appendChild(d);
      }
      updateSettingGridUI();
    }

    function onSettingCellClick(e){
      const cell=e.target.closest('.setting-grid-cell'); if(!cell) return;
      const row=+cell.dataset.row, col=+cell.dataset.col; const coord={row,col};
      const sel=itemSelector.querySelector('input[name="item-type"]:checked').value;
      
      // æ—¢å­˜ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¤œç´¢
      const isS=gameConfig.start && gameConfig.start.row===row && gameConfig.start.col===col;
      const isG=gameConfig.goal && gameConfig.goal.row===row && gameConfig.goal.col===col;
      const wpi=gameConfig.waypoints.findIndex(w=>w.row===row && w.col===col);
      const wli=gameConfig.walls.findIndex(w=>w.row===row && w.col===col);
      const ipi=gameConfig.impassables.findIndex(w=>w.row===row && w.col===col);
      const owi=gameConfig.oneWayWalls.findIndex(w=>w.row===row && w.col===col); // â‘¡

      // é¸æŠã¨ç•°ãªã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’å‰Šé™¤ï¼ˆæ¶ˆã—ã‚´ãƒ å‹•ä½œï¼‰
      if (sel!=='start' && isS) gameConfig.start=null;
      if (sel!=='goal' && isG) gameConfig.goal=null;
      if (sel!=='waypoint' && wpi>-1) gameConfig.waypoints.splice(wpi,1);
      if (sel!=='wall' && wli>-1) gameConfig.walls.splice(wli,1);
      if (sel!=='impassable' && ipi>-1) gameConfig.impassables.splice(ipi,1);
      // â‘¡
      if (sel!=='oneWayUp' && sel!=='oneWayDown' && sel!=='oneWayLeft' && sel!=='oneWayRight' && owi>-1) gameConfig.oneWayWalls.splice(owi,1);

      // æ–°ã‚¢ã‚¤ãƒ†ãƒ ã‚’é…ç½®
      switch(sel){
        case 'start': gameConfig.start=coord; break;
        case 'goal': gameConfig.goal=coord; break;
        case 'waypoint': // â‘¢ é †åºä»˜ã
          if(wpi===-1){
            if(gameConfig.waypoints.length < 6){
              const nextOrder = gameConfig.waypoints.length + 1;
              gameConfig.waypoints.push({row, col, order: nextOrder});
            } else {
              flashError('é€šéåœ°ç‚¹ã¯6å€‹ã¾ã§ã§ã™');
            }
          }
          break;
        case 'wall':
          if(wli===-1) gameConfig.walls.push(coord);
          break;
        case 'impassable':
          if(ipi===-1) gameConfig.impassables.push(coord);
          break;
        // â‘¡ ä¸€æ–¹å‘å£
        case 'oneWayUp':
        case 'oneWayDown':
        case 'oneWayLeft':
        case 'oneWayRight':
          if(owi===-1) {
            const direction = sel.replace('oneWay', '').toLowerCase(); // 'up', 'down', ...
            gameConfig.oneWayWalls.push({ row, col, direction });
          }
          break;
        case 'erase':
          break; // å‰Šé™¤ã¯ä¸Šã®ãƒ­ã‚¸ãƒƒã‚¯ã§å®Œäº†
      }
      
      // â‘¢ ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆé †åºã‚’å†å‰²ã‚Šå½“ã¦
      gameConfig.waypoints.sort((a,b) => a.order - b.order);
      gameConfig.waypoints.forEach((wp, i) => wp.order = i + 1);

      updateSettingGridUI();
    }

    function updateSettingGridUI(){
      settingGridContainer.querySelectorAll('.setting-grid-cell').forEach(c=>{
        c.textContent='';
        c.classList.remove('setting-wall-cell', 'setting-oneway-cell');
      });
      gameConfig.walls.forEach(w=>{
        const c=getSetCell(w.row,w.col);
        if(c) { c.classList.add('setting-wall-cell'); c.textContent=''; }
      });
      // â‘¡
      gameConfig.oneWayWalls.forEach(w=>{
        const c=getSetCell(w.row,w.col);
        if(c) { 
            c.classList.add('setting-oneway-cell'); 
            c.textContent = onewayIcons[w.direction] || '?';
        }
      });
      gameConfig.impassables.forEach(w=>{ const c=getSetCell(w.row,w.col); if(c) c.textContent='ğŸ‘»'; });
      // â‘¢
      gameConfig.waypoints.forEach(wp=>{ 
        const c=getSetCell(wp.row,wp.col); 
        if(c) c.textContent = waypointIcons[wp.order - 1] || `${wp.order}`;
      });
      if (gameConfig.goal){ const c=getSetCell(gameConfig.goal.row,gameConfig.goal.col); if(c) c.textContent='ğŸ '; }
      if (gameConfig.start){ const c=getSetCell(gameConfig.start.row,gameConfig.start.col); if(c) c.innerHTML='<span class="text-green-600">â–²</span>'; }
    }
    const getSetCell=(r,c)=>settingGridContainer.querySelector(`[data-row="${r}"][data-col="${c}"]`);

    randomAllBtn.addEventListener('click', async ()=>{
      await initAudio();
      gameConfig.gridRows=rand(3,10);
      gameConfig.gridCols=rand(3,10);
      gridRowsInput.value=gameConfig.gridRows;
      gridColsInput.value=gameConfig.gridCols;
      gameConfig.waypointsCount=rand(0,3); // ãƒ©ãƒ³ãƒ€ãƒ ã¯3å€‹ã¾ã§ã«
      randomizeItemPlacement();
      updateSettingGrid();
    });
    randomItemsBtn.addEventListener('click', async ()=>{
      await initAudio();
      gameConfig.gridRows=+gridRowsInput.value;
      gameConfig.gridCols=+gridColsInput.value;
      gameConfig.waypointsCount=gameConfig.waypoints.length;
      randomizeItemPlacement();
      updateSettingGridUI();
    });

    function randomizeItemPlacement(){
      const rows=gameConfig.gridRows, cols=gameConfig.gridCols, count=gameConfig.waypointsCount; const used=new Set();
      gameConfig.walls=[];
      gameConfig.impassables=[];
      gameConfig.oneWayWalls=[]; // â‘¡
      gameConfig.start = randomEmpty(rows,cols,used);
      gameConfig.goal = randomEmpty(rows,cols,used);
      gameConfig.waypoints=[]; // â‘¢
      for(let i=0;i<count;i++){
        const p=randomEmpty(rows,cols,used);
        gameConfig.waypoints.push({row:p.row,col:p.col, order: i + 1});
      }
    }

    startGameBtn.addEventListener('click', async ()=>{
      await initAudio();
      if(parseSettings()) showGameView();
    });

    function parseSettings(){
      settingsError.textContent='';
      gameConfig.gridRows=+gridRowsInput.value;
      gameConfig.gridCols=+gridColsInput.value;
      gameConfig.waypointsCount=gameConfig.waypoints.length;
      gameConfig.playerIcon = iconSelector.querySelector('input[name="player-icon"]:checked')?.value || 'arrow'; // â‘§

      try{
        if(!gameConfig.start) throw new Error('ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é…ç½®ã—ã¦ãã ã•ã„');
        if(!gameConfig.goal) throw new Error('ã‚´ãƒ¼ãƒ«ã‚’é…ç½®ã—ã¦ãã ã•ã„');
        
        // â‘¡, â‘¢ ã‚’å«ã‚€å…¨ã‚¢ã‚¤ãƒ†ãƒ 
        const all=[
            gameConfig.start,
            gameConfig.goal,
            ...gameConfig.waypoints,
            ...gameConfig.walls, 
            ...gameConfig.impassables,
            ...gameConfig.oneWayWalls
        ];
        const set=new Set();
        for(const a of all){
          const s=`${a.row},${a.col}`;
          if(set.has(s)) throw new Error('ã‚¢ã‚¤ãƒ†ãƒ ã®é…ç½®ãŒé‡è¤‡ã—ã¦ã„ã¾ã™');
          set.add(s);
        }
        return true;
      }catch(e){
        settingsError.textContent=e.message;
        return false;
      }
    }

    // ã‚²ãƒ¼ãƒ ãƒ“ãƒ¥ãƒ¼
    backToSettingsBtn.addEventListener('click', showSettingsView);
    modeAbsoluteBtn.addEventListener('click',()=>setMoveMode('absolute'));
    modeCardinalBtn.addEventListener('click',()=>setMoveMode('cardinal'));
    modeRelativeBtn.addEventListener('click',()=>setMoveMode('relative'));

    function setMoveMode(mode){
      gameState.moveMode=mode; gameState.sequence=[]; updateSequenceDisplay(); resetPlayer();
      [modeAbsoluteBtn, modeCardinalBtn, modeRelativeBtn].forEach(b => b.classList.remove('active'));
      if(mode==='absolute') modeAbsoluteBtn.classList.add('active');
      else if(mode==='cardinal') modeCardinalBtn.classList.add('active');
      else modeRelativeBtn.classList.add('active');

      if(mode==='cardinal') gridWrapper.classList.add('mode-cardinal');
      else gridWrapper.classList.remove('mode-cardinal');

      if(mode==='absolute' || mode==='cardinal'){
        const labels = (mode==='absolute')
          ? {up:'â¬†ï¸', left:'â¬…ï¸', right:'â¡ï¸', down:'â¬‡ï¸'}
          : {up:'åŒ—', left:'è¥¿', right:'æ±', down:'å—'};

        directionPad.innerHTML=`<div class="grid grid-cols-3 grid-rows-3 gap-1 w-full h-full place-items-center">
          <div class="col-start-2 row-start-1"><button data-action="up" class="dir-btn p-2 text-2xl font-bold w-full h-full flex items-center justify-center rounded-lg">...</button></div>
          <div class="col-start-1 row-start-2"><button data-action="left" class="dir-btn p-2 text-2xl font-bold w-full h-full flex items-center justify-center rounded-lg">...</button></div>
          <div class="col-start-3 row-start-2"><button data-action="right" class="dir-btn p-2 text-2xl font-bold w-full h-full flex items-center justify-center rounded-lg">...</button></div>
          <div class="col-start-2 row-start-3"><button data-action="down" class="dir-btn p-2 text-2xl font-bold w-full h-full flex items-center justify-center rounded-lg">...</button></div>
        </div>`;
        // ãƒ©ãƒ™ãƒ«ã‚’é…å»¶è¨­å®šï¼ˆinnerHTMLã®ãƒ‘ãƒ¼ã‚¹å¾…ã¡ï¼‰
        setTimeout(() => {
            directionPad.querySelector('[data-action="up"]').innerHTML = labels.up;
            directionPad.querySelector('[data-action="left"]').innerHTML = labels.left;
            directionPad.querySelector('[data-action="right"]').innerHTML = labels.right;
            directionPad.querySelector('[data-action="down"]').innerHTML = labels.down;
        }, 0);
      } else {
        directionPad.innerHTML=`<div class="grid grid-cols-3 gap-2 w-full h-full items-center">
          <button data-action="turnLeft" class="dir-btn px-3 py-2 border rounded font-bold text-gray-700 bg-gray-50">å·¦ã‚’å‘ã</button>
          <button data-action="forward" class="dir-btn px-3 py-2 border rounded font-bold text-gray-700 bg-gray-50">å‰é€²ã™ã‚‹</button>
          <button data-action="turnRight" class="dir-btn px-3 py-2 border rounded font-bold text-gray-700 bg-gray-50">å³ã‚’å‘ã</button>
        </div>`;
      }
      addDirListeners();
    }

    function addDirListeners(){
      directionPad.querySelectorAll('.dir-btn').forEach(btn=>{
        btn.addEventListener('click',async ()=>{
          await initAudio();
          if(gameState.isRunning) return;
          const a=btn.dataset.action;
          gameState.sequence.push(a);
          gameState.originalSequence = [...gameState.sequence]; // â‘¥ ãƒ‡ãƒãƒƒã‚°ç”¨ã«å³æ™‚åæ˜ 
          updateSequenceDisplay();
        });
      });
    }

    undoBtn.addEventListener('click',async ()=>{
      await initAudio();
      if(gameState.isRunning) return;
      gameState.sequence.pop();
      gameState.originalSequence = [...gameState.sequence];
      updateSequenceDisplay();
      highlightSequenceCommand(-1); // â‘¥ ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
      toast(''); // â‘¥ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£é™¤
    });
    resetBtn.addEventListener('click', async ()=>{
      await initAudio();
      if(gameState.isRunning) return;
      gameState.sequence=[];
      gameState.originalSequence = [];
      updateSequenceDisplay();
      generateMap(); // ãƒãƒƒãƒ—å†æç”»ï¼ˆ1ï¸âƒ£ãªã©ã‚’å…ƒã«æˆ»ã™ï¼‰
      resetPlayer();
      toast(''); // â‘¥ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è§£é™¤
    });

    stepBtn.addEventListener('click', async ()=>{
      await initAudio();
      if(gameState.isRunning || gameState.sequence.length===0) return;
      
      // stepBtnãŒåˆã‚ã¦æŠ¼ã•ã‚ŒãŸï¼ˆã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆå¾Œï¼‰
      if(gameState.currentStepIndex === 0 && !gameState.isRunning) {
         resetPlayer(); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã«æˆ»ã™
         gameState.originalSequence = [...gameState.sequence]; // å®Ÿè¡Œã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’ç¢ºå®š
      }
      
      gameState.isRunning=true; setDisabled(true);
      gameState.exploded=false;
      
      const action = gameState.originalSequence[gameState.currentStepIndex];
      highlightSequenceCommand(gameState.currentStepIndex); // â‘£
      
      if (action) {
        const result = await runOneStep(action);
        
        if (result !== 'success') {
          handleFailure(result, gameState.currentStepIndex); // â‘¥
          // å¤±æ•—ã—ãŸã‚‰stepIndexã‚’é€²ã‚ãªã„
        } else {
          gameState.currentStepIndex++; // æˆåŠŸã—ãŸã‚‰æ¬¡ã¸
          checkGoal(); // æ¯ã‚¹ãƒ†ãƒƒãƒ—ã‚´ãƒ¼ãƒ«åˆ¤å®š
        }
      }

      gameState.isRunning=false; setDisabled(false);
    });
    
    runBtn.addEventListener('click', async ()=>{
      await initAudio();
      if(gameState.isRunning||gameState.sequence.length===0) return;
      // â‘¥
      gameState.originalSequence = [...gameState.sequence];
      gameState.totalMoves = gameState.sequence.length; // â‘ 
      runSequence();
    });

    function showSettingsView(){
      gameView.classList.add('hidden');
      settingsView.classList.remove('hidden');
      gameState.sequence=[];
      gameState.originalSequence = [];
      updateSequenceDisplay();
      setMoveMode('absolute');
    }
    
    function showGameView(){
      settingsView.classList.add('hidden');
      gameView.classList.remove('hidden');
      
      // â‘§ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š
      const iconMap = {
          arrow: '<span class="text-green-600">â–²</span>',
          car: 'ğŸš—',
          chick: 'ğŸ¤'
      };
      playerElement.innerHTML = `<span class="player-icon-inner">${iconMap[gameConfig.playerIcon] || iconMap.arrow}</span>`;

      // â‘  ç›®æ¨™ã‚¿ãƒ¼ãƒ³æ•°è¨ˆç®—ï¼ˆç°¡æ˜“ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼‰
      const baseMoves = (gameConfig.gridRows - 1) + (gameConfig.gridCols - 1); // ãƒãƒƒãƒ—å¯¾è§’ç·š
      gameConfig.targetMoves = Math.ceil(baseMoves * 1.2) + (gameConfig.waypoints.length * 3) + gameConfig.walls.length + (gameConfig.oneWayWalls.length * 2);
      turnInfo.textContent = `ç›®æ¨™: ${gameConfig.targetMoves} æ‰‹`;

      generateMap();
      resetPlayer();
      setMoveMode('absolute');
      toast(''); // â‘¥ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
    }

    function generateMap(){
      gridContainer.innerHTML='';
      gridContainer.style.gridTemplateColumns=`repeat(${gameConfig.gridCols}, minmax(0,1fr))`;
      const parent=gridContainer.parentElement.parentElement;
      const cw=parent.clientWidth-40;
      const ch=parent.clientHeight-40;
      const size=Math.min(cw/gameConfig.gridCols, ch/gameConfig.gridRows);
      gridContainer.style.width=`${size*gameConfig.gridCols}px`;
      gridContainer.style.height=`${size*gameConfig.gridRows}px`;

      gridWrapper.style.width = gridContainer.style.width;
      gridWrapper.style.height = gridContainer.style.height;

      const font=size*0.4; playerElement.style.fontSize=`${font*0.8}px`;
      for(let r=0;r<gameConfig.gridRows;r++) for(let c=0;c<gameConfig.gridCols;c++){
        const cell=document.createElement('div');
        cell.id=`cell-${r}-${c}`;
        cell.className='grid-cell';
        cell.style.fontSize=`${font}px`;
        if (gameConfig.walls.some(w=>w.row===r&&w.col===c)) {
          cell.classList.add('wall-cell');
        }
        // â‘¡
        else if (gameConfig.oneWayWalls.some(w=>w.row===r&&w.col===c)) {
            const ow = gameConfig.oneWayWalls.find(w=>w.row===r&&w.col===c);
            cell.textContent = onewayIcons[ow.direction] || '?';
            cell.classList.add('setting-oneway-cell'); // è¦‹ãŸç›®ã‚’å°‘ã—å¤‰ãˆã‚‹
        }
        else if (gameConfig.impassables.some(w=>w.row===r&&w.col===c)) cell.textContent='ğŸ‘»';
        else if (gameConfig.goal && gameConfig.goal.row===r && gameConfig.goal.col===c) cell.textContent='ğŸ ';
        else {
          // â‘¢
          const wp=gameConfig.waypoints.find(w=>w.row===r&&w.col===c);
          if(wp) cell.textContent = waypointIcons[wp.order - 1] || `${wp.order}`;
        }
        gridContainer.appendChild(cell);
      }
    }

    function resetPlayer(){
      if(!gameConfig.start) return;
      gameState.player.row=gameConfig.start.row;
      gameState.player.col=gameConfig.start.col;
      changeDirection('up'); // â‘§ å›è»¢ãƒªã‚»ãƒƒãƒˆ
      gameState.collectedWaypoints.clear();
      gameState.nextWaypointOrder = 1; // â‘¢
      gameState.currentStepIndex = 0; // â‘£
      gameState.exploded = false;
      highlightSequenceCommand(-1); // â‘¥ ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
      
      const s=document.getElementById(`cell-${gameConfig.start.row}-${gameConfig.start.col}`);
      if(s){ playerElement.remove(); s.appendChild(playerElement);}
    }

    async function runSequence(){
      gameState.isRunning=true; setDisabled(true);
      gameState.exploded=false;
      resetPlayer(); // å®Ÿè¡Œå‰ã«ãƒªã‚»ãƒƒãƒˆ (currentStepIndex=0 ã«)
      
      const sequenceToRun = [...gameState.originalSequence];
      await delay(200);
      
      while(gameState.currentStepIndex < sequenceToRun.length){
        const action = sequenceToRun[gameState.currentStepIndex];
        highlightSequenceCommand(gameState.currentStepIndex); // â‘£
        
        const result = await runOneStep(action);
        
        if(result !== 'success'){
            gameState.exploded = true;
            handleFailure(result, gameState.currentStepIndex); // â‘¥
            break; // ğŸ‘»ãƒ’ãƒƒãƒˆç­‰ã§å³çµ‚äº†
        }
        
        gameState.currentStepIndex++; // æˆåŠŸã—ãŸã‚‰æ¬¡ã¸

        // â‘£ ç›¸å¯¾æ–¹ä½ã®å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾…ã¡ã¯ runOneStep å†…ã§å‡¦ç†
        // ç§»å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾…ã¡
        if (action === 'forward' || gameState.moveMode !== 'relative') {
             await delay(500);
        }
      }
      
      // çµ‚äº†åˆ¤å®šï¼ˆğŸ‘»ã§çµ‚ã‚ã£ã¦ãªã‘ã‚Œã°ï¼‰
      if(!gameState.exploded){
        // â‘¢
        const reachedGoal = (gameState.player.row===gameConfig.goal.row && gameState.player.col===gameConfig.goal.col);
        const allWaypoints = gameState.nextWaypointOrder === (gameConfig.waypoints.length + 1);

        if(reachedGoal && allWaypoints){
          playSuccess();
          const goal=document.getElementById(`cell-${gameConfig.goal.row}-${gameConfig.goal.col}`);
          if(goal){ goal.classList.add('effect-tada'); setTimeout(()=>goal.classList.remove('effect-tada'),1000); }
          
          // â‘  ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒã‚§ãƒƒã‚¯
          if (gameState.totalMoves <= gameConfig.targetMoves) {
              toast(`Great! (${gameState.totalMoves}æ‰‹)`, 'success');
          } else {
              toast(`ã‚¯ãƒªã‚¢! (${gameState.totalMoves}æ‰‹)`, 'success');
          }

        }else{
          playFailLong();
          if (!reachedGoal) toast('ã‚´ãƒ¼ãƒ«ã«ãŸã©ã‚Šç€ã‘ã¾ã›ã‚“ã§ã—ãŸ', 'error');
          else if (!allWaypoints) toast('é€šéåœ°ç‚¹ã‚’ã™ã¹ã¦é€šã£ã¦ã„ã¾ã›ã‚“', 'error');
        }
      }
      
      gameState.isRunning=false; setDisabled(false);
    }

    // â‘£, â‘¥ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼•æ•°ã§å—ã‘å–ã‚‹
    async function runOneStep(action){
      if(!action) return 'success';
      let nr=gameState.player.row, nc=gameState.player.col; 
      let moved=false;
      let moveDir = ''; // â‘¡

      if (gameState.moveMode==='absolute' || gameState.moveMode==='cardinal'){
        changeDirection(action, false); // â‘£ å›è»¢ã‚¢ãƒ‹ãƒ¡ãªã—
        if(action==='up') { nr--; moveDir='up'; }
        else if(action==='down') { nr++; moveDir='down'; }
        else if(action==='left') { nc--; moveDir='left'; }
        else if(action==='right') { nc++; moveDir='right'; }
        moved=true;
      } else {
        const cur=gameState.player.dir;
        if(action==='forward'){
          changeDirection(cur, false); // å›è»¢ãªã—
          if(cur==='up') { nr--; moveDir='up'; }
          else if(cur==='down') { nr++; moveDir='down'; }
          else if(cur==='left') { nc--; moveDir='left'; }
          else if(cur==='right') { nc++; moveDir='right'; }
          moved=true;
        }
        // â‘£ å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        else if(action==='turnRight'){ const map={up:'right', right:'down', down:'left', left:'up'}; changeDirection(map[cur], true); await delay(300); }
        else if(action==='turnLeft'){ const map={up:'left', left:'down', down:'right', right:'up'}; changeDirection(map[cur], true); await delay(300); }
      }

      if(moved){
        // â‘¥ æ å¤–
        if(nr<0||nr>=gameConfig.gridRows||nc<0||nc>=gameConfig.gridCols) return 'hitOutOfBounds';
        // â‘¥ å£
        if(gameConfig.walls.some(w=>w.row===nr&&w.col===nc)) return 'hitWall';

        // â‘¡ ä¸€æ–¹å‘å£
        const oneWay = gameConfig.oneWayWalls.find(w => w.row === nr && w.col === nc);
        if (oneWay && oneWay.direction !== moveDir) {
            return 'hitOneWayWall'; // è¨±å¯ã•ã‚ŒãŸæ–¹å‘ä»¥å¤–ã§ã®é€²å…¥
        }

        // é€²è¡Œç¢ºå®š
        gameState.player.row=nr; gameState.player.col=nc;
        const cell=document.getElementById(`cell-${nr}-${nc}`); if(cell) cell.appendChild(playerElement);

        // â‘¥ ğŸ‘»
        if(gameConfig.impassables.some(w=>w.row===nr&&w.col===nc)){
          return 'hitImpassable';
        }

        // â‘¢ ã‚¦ã‚§ã‚¤ãƒã‚¤ãƒ³ãƒˆå–å¾—
        const wp = gameConfig.waypoints.find(w=>w.row===nr && w.col===nc);
        if(wp){
          const key=`${nr},${nc}`;
          if(!gameState.collectedWaypoints.has(key)){
            // â‘¢ é †åºãƒã‚§ãƒƒã‚¯
            if (wp.order === gameState.nextWaypointOrder) {
                gameState.collectedWaypoints.add(key);
                gameState.nextWaypointOrder++;
                playTone(440,0.08);
                const effect=document.createElement('div');
                effect.className='effect-ping';
                if(cell){
                  const p=cell.querySelector('#player');
                  p?cell.insertBefore(effect,p):cell.appendChild(effect);
                  setTimeout(()=>effect.remove(),1000);
                }
                // 1ï¸âƒ£ ã‚’æ¶ˆã™
                Array.from(cell.childNodes)
                  .filter(n => n.nodeType === Node.TEXT_NODE && n.textContent.trim() !== '')
                  .forEach(n => n.textContent = '');
            } else if (wp.order > gameState.nextWaypointOrder) {
                // é †åºãŒé•ã†
                return 'wrongWaypointOrder';
            }
            // (wp.order < gameState.nextWaypointOrder) ã¯æ—¢ã«è¸ã‚“ã å ´æ‰€
          }
        }
      }
      return 'success'; // æˆåŠŸ
    }

    // â‘£, â‘§ å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
    function changeDirection(dir, animate = false){
      gameState.player.dir=dir;
      const dirMap = { up: '0deg', right: '90deg', down: '180deg', left: '270deg' };
      const innerIcon = playerElement.querySelector('.player-icon-inner');
      if (innerIcon) {
          if (animate) {
              innerIcon.style.transition = 'transform 0.3s ease-in-out';
          } else {
              innerIcon.style.transition = 'none';
          }
          innerIcon.style.transform = `rotate(${dirMap[dir]})`;
      }
    }

    function checkGoal(){
      const atGoal = gameState.player.row===gameConfig.goal.row && gameState.player.col===gameConfig.goal.col;
      const all = gameState.nextWaypointOrder === (gameConfig.waypoints.length + 1);
      if(atGoal && all){
        const goal=document.getElementById(`cell-${gameConfig.goal.row}-${gameConfig.goal.col}`);
        if(goal){ goal.classList.add('effect-tada'); setTimeout(()=>goal.classList.remove('effect-tada'),1000); }
        // (stepå®Ÿè¡Œæ™‚ã¯ã“ã“ã§éŸ³ã‚’é³´ã‚‰ã—ã¦ã‚‚è‰¯ã„)
        // playSuccess();
      }
    }

    function updateSequenceDisplay(){
      let map; let modeClass = 'px-1';
      if(gameState.moveMode === 'cardinal'){
        map={ up:'åŒ—', down:'å—', left:'è¥¿', right:'æ±' };
        modeClass = 'px-2 py-1 rounded-md cmd-relative';
      } else if (gameState.moveMode === 'relative'){
        map={ forward:'å‰', turnLeft:'å·¦', turnRight:'å³' };
        modeClass = 'px-2 py-1 rounded-md cmd-relative';
      } else {
        map={ up:'â¬†ï¸', down:'â¬‡ï¸', left:'â¬…ï¸', right:'â¡ï¸' };
      }
      // â‘£ data-index ã‚’è¿½åŠ 
      sequenceDisplay.innerHTML = gameState.sequence.map((a, i)=>`<span data-index="${i}" class="${modeClass} transition-transform duration-150">${map[a]||a}</span>`).join('');
    }

    // â‘¥ å¤±æ•—å‡¦ç†
    function handleFailure(reason, index) {
        const reasonMap = {
            hitWall: 'å£ã«ã¶ã¤ã‹ã‚Šã¾ã—ãŸ',
            hitOutOfBounds: 'ã‚³ãƒ¼ã‚¹ã®å¤–ã«å‡ºã¾ã—ãŸ',
            hitImpassable: 'ğŸ‘»ã«ã¶ã¤ã‹ã‚Šã¾ã—ãŸ',
            hitOneWayWall: 'ä¸€æ–¹é€šè¡Œã®å£ã«å…¥ã‚Œã¾ã›ã‚“',
            wrongWaypointOrder: 'é€šéåœ°ç‚¹ã®é †åºãŒé•ã„ã¾ã™',
            default: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
        };
        const msg = reasonMap[reason] || reasonMap.default;
        console.error(`Failure at step ${index}: ${reason}`);
        toast(msg, 'error'); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        highlightSequenceCommand(index, true); // èµ¤ãå¼·èª¿
        
        if (reason === 'hitImpassable') playGhostTriple();
        else playFailLong();
    }
    
    // â‘£, â‘¥ ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å¼·èª¿
    function highlightSequenceCommand(index, isError = false) {
        sequenceDisplay.querySelectorAll('span').forEach((span, i) => {
            span.classList.remove('seq-highlight', 'seq-error');
            if (i === index) {
                if (isError) {
                    span.classList.add('seq-error');
                } else {
                    span.classList.add('seq-highlight');
                }
            }
        });
    }

    function setDisabled(dis){
      [undoBtn,resetBtn,runBtn,stepBtn,modeAbsoluteBtn,modeCardinalBtn,modeRelativeBtn, backToSettingsBtn].forEach(b=>{
        b.disabled=dis; b.classList.toggle('opacity-50',dis);
      });
      directionPad.querySelectorAll('.dir-btn').forEach(b=>b.disabled=dis);
    }

    function randomEmpty(rows,cols,used){ let r,c,s; do{ r=rand(0,rows-1); c=rand(0,cols-1); s=`${r},${c}`; }while(used.has(s)); used.add(s); return {row:r,col:c}; }

    function flashError(msg){ settingsError.textContent=msg; setTimeout(()=>settingsError.textContent='',1800); }
    
    // â‘¥ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆãƒˆãƒ¼ã‚¹ãƒˆï¼‰
    function toast(msg, type = 'success') {
        messageArea.textContent = msg;
        messageArea.classList.remove('text-green-600', 'text-red-600', 'opacity-0');
        if (type === 'error') {
            messageArea.classList.add('text-red-600');
        } else {
            messageArea.classList.add('text-green-600');
        }
        messageArea.style.display = msg ? 'block' : 'none'; // è¡¨ç¤º/éè¡¨ç¤º
    }

    // åˆæœŸåŒ–
    updateSettingGrid();
    setMoveMode('absolute');

    // iPadã®æ‹¡å¤§é˜²æ­¢ï¼ˆãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ï¼ãƒ”ãƒ³ãƒï¼‰
    document.addEventListener('dblclick', e => e.preventDefault(), { passive:false });
    let lastTouchEnd = 0;
    document.addEventListener('touchend', e => {
      const now = Date.now();
      if(now - lastTouchEnd <= 300){ e.preventDefault(); }
      lastTouchEnd = now;
    }, { passive:false });
    document.addEventListener('gesturestart', e => e.preventDefault());
  });
  </script>
</body>
</html>
